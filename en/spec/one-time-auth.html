<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Shadowsocks - One Time Auth</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content=""><meta name="author" content=""><link rel="stylesheet" href="/assets/css/app.css"><!--[if lt IE 9]><script src="/assets/js/html5.js"></script><![endif]--><link rel="shortcut icon" href="/assets/img/favicon/favicon.ico"><link rel="apple-touch-icon" href="/assets/img/favicon/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicon/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicon/apple-touch-icon-114x114.png"></head><body><div id="wrap" class="boxed"><header><div class="container clearfix"><div class="four columns"><div class="logo"><a href="/en/index.html">shadowsocks</a></div></div><div class="twelve columns"><nav id="menu" class="navigation"><ul id="nav"><li><a href="javascript:void" class="">download</a><ul><li><a href="/en/download/clients.html">Clients</a></li><li><a href="/en/download/servers.html">Servers</a></li></ul></li><li><a href="javascript:void" class="">config</a><ul><li><a href="/en/config/quick-guide.html">Quick Guide</a></li><li><a href="/en/config/advanced.html">Advanced</a></li></ul></li><li><a href="javascript:void" class="active">spec</a><ul><li><a href="/en/spec/protocol.html">Protocol</a></li><li><a href="/en/spec/cipher.html">Cipher</a></li><li><a href="/en/spec/one-time-auth.html">One Time Auth</a></li><li><a href="/en/spec/aead.html">Aead</a></li></ul></li><li><a href="javascript:void" class="">about</a><ul><li><a href="/en/about/contributors.html">Contributors</a></li></ul></li><li><a href="javascript:void">en</a><ul><li><a href="/en/index.html">en</a></li></ul></li></ul></nav></div><div class="sixteen columns"><hr></div></div></header><div class="container clearfix"><div class="sixteen columns"><h1 class="page-title">One Time Auth<a href="https://github.com/madeye/shadowsocks-org/edit/master/docs/spec/03-one-time-auth.md" data-tooltip="Edit this page on GitHub" class="edit"><i class="icon-edit"></i></a><span class="line"></span></h1></div><div class="page-columns"><div id="markdown" class="sixteen columns bottom"><h1>(Deprecated)</h1><p>One-time authentication (shortened as <em>OTA</em>) is a new experimental feature designed to improve the security against <a href="https://en.wikipedia.org/wiki/Chosen-ciphertext_attack">CCA</a>. You should understand the <a href="protocol.html">protocol</a> before reading this document.</p><p>By default, the server that supports OTA should run in the compatible mode. OTA is only applied if the client&#39;s request header has a flag set. However, if the server switch on OTA explicitly, all clients must switch on OTA, otherwise connections will be denied.</p><p>The authentication method is <strong>HMAC-SHA1</strong> which has wide supports among all major platforms and fairly good speed.</p><h2>TCP</h2><p>The structure of an OTA-enabled request (unencrypted) is shown below:</p><pre><code><span class="hljs-code">+------+</span>---------------------<span class="hljs-code">+------------------+</span>-----------+
<span class="hljs-section">| ATYP | Destination Address | Destination Port | HMAC-SHA1 |
+------+---------------------+------------------+-----------+</span>
<span class="hljs-section">|  1   |       Variable      |         2        |    10     |
+------+---------------------+------------------+-----------+</span></code></pre><p>ATYP is a 8-bit char where the rightmost four bits, 0b00001111 (0xf), are reserved for address types, the flag bit of OTA is 0b00010000 (0x10). In C/C++, simply check if <code>ATYP &amp; 0x10 == 0x10</code>, then OTA is enabled.</p><p>The key of HMAC-SHA1 is (IV + KEY), and the input is the whole header (not including HMAC-SHA1). The output of HMAC-SHA1 is truncated to leftmost 80 bits (10 bytes) according to <a href="https://tools.ietf.org/html/rfc2104#page-5">RFC 2104</a>.</p><h3>Chunk Authentication</h3><p>The structure of an OTA-enabled chunk (decrypted) of shadowsocks TCP relay is shown below:</p><pre><code><span class="hljs-code">+----------+</span>-----------<span class="hljs-code">+----------+</span>----
<span class="hljs-section">| DATA.LEN | HMAC-SHA1 |   DATA   | ...
+----------+-----------+----------+----</span>
<span class="hljs-section">|     2    |     10    | Variable | ...
+----------+-----------+----------+----</span></code></pre><p>DATA.LEN is a 16-bit big-endian integer indicating the length of DATA.</p><p>The input of HMAC-SHA1 is DATA. And the key of HMAC-SHA1 is (IV + Chunk ID) where Chunk ID is an unsigned integer counted per connection from 0. In order to achieve this, both server side and client side need to keep a counter for each TCP connection. Chunk ID must be converted to big-endian before constructing the key of HMAC-SHA1.</p><p>For a client, after constructing an OTA-enabled request, the whole chunk is encrypted as a payload then sent to server-side.</p><p>Tips:</p><ul><li>The server must check the completeness of a shadowsocks TCP request before verifying HMAC-SHA1 and forwarding.</li><li>The chunk authentication is only applied for the packets sent from client-side shadowsocks.</li></ul><h2>UDP</h2><p>There is no <em>session</em> in UDP relay, each UDP packet contains both header and data. Therefore, for an OTA-enabled UDP packet, the datagram structure (unencrypted) is slightly different:</p><pre><code><span class="hljs-code">+------+</span>---------------------<span class="hljs-code">+------------------+</span>----------<span class="hljs-code">+-----------+</span>
<span class="hljs-section">| ATYP | Destination Address | Destination Port |   DATA   | HMAC-SHA1 |
+------+---------------------+------------------+----------+-----------+</span>
<span class="hljs-section">|  1   |       Variable      |         2        | Variable |     10    |
+------+---------------------+------------------+----------+-----------+</span></code></pre><p>The key of HMAC-SHA1 is (IV + KEY), and the input is the header plus data.</p></div></div></div><div class="push"></div></div><footer><div class="container"><div class="sisteen columns"><span class="copyright"><a href="https://github.com/shadowsocks">Projects of Shadowsocks</a>&nbsp;are distributed under different licenses, including &nbsp;<a href="https://github.com/shadowsocks/shadowsocks/blob/master/LICENSE">APL 2.0,</a>&nbsp;<a href="https://github.com/shadowsocks/shadowsocks-libev/blob/master/LICENSE">GPLv3</a>&nbsp; and &nbsp;<a href="https://github.com/shadowsocks/libQtShadowsocks/blob/master/LICENSE">LGPLv3</a>. Theme by <a href="http://karma-runner.github.io">Karma</a>.</span></div></div></footer></body><script src="/assets/js/app.js"></script><script src="/assets/js/analytics.js"></script></html>